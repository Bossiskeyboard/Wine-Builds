From d592b0f19b1b20aad8be84165a65049b549522ce Mon Sep 17 00:00:00 2001
From: Paul Gofman <pgofman@codeweavers.com>
Date: Mon, 17 Nov 2025 16:59:31 -0600
Subject: [PATCH] server: esync, fsync: Create server events as esync / fsync.

CW-Bug-Id: #26231
---
 server/directory.c | 12 +++++++++++-
 server/esync.h     |  4 ++++
 server/fsync.h     |  4 ++++
 3 files changed, 19 insertions(+), 1 deletion(-)

diff --git a/server/directory.c b/server/directory.c
index cd17883458e..5ba66ec8d5b 100644
--- a/server/directory.c
+++ b/server/directory.c
@@ -38,6 +38,9 @@
 #include "file.h"
 #include "unicode.h"
 
+#include "esync.h"
+#include "fsync.h"
+
 #define HASH_SIZE 7  /* default hash size */
 
 static const WCHAR objtype_name[] = {'T','y','p','e'};
@@ -492,7 +495,14 @@ void init_directories( struct fd *intl_fd )
 
     /* events */
     for (i = 0; i < ARRAY_SIZE( kernel_events ); i++)
-        release_object( create_event( &dir_kernel->obj, &kernel_events[i], OBJ_PERMANENT, 1, 0, NULL ));
+    {
+        if (do_fsync())
+            release_object( create_fsync( &dir_kernel->obj, &kernel_events[i], OBJ_PERMANENT, 0, 0xdeadbeef, FSYNC_MANUAL_EVENT, NULL ));
+        else if (do_esync())
+            release_object( create_esync( &dir_kernel->obj, &kernel_events[i], OBJ_PERMANENT, 0, 0, ESYNC_MANUAL_EVENT, NULL ));
+        else
+            release_object( create_event( &dir_kernel->obj, &kernel_events[i], OBJ_PERMANENT, 1, 0, NULL ));
+    }
     release_object( create_keyed_event( &dir_kernel->obj, &keyed_event_crit_sect_str, OBJ_PERMANENT, NULL ));
 
     /* mappings */
diff --git a/server/esync.h b/server/esync.h
index d39f4efa3ec..c7f2679560f 100644
--- a/server/esync.h
+++ b/server/esync.h
@@ -33,3 +33,7 @@ extern const struct object_ops esync_ops;
 void esync_set_event( struct esync *esync );
 void esync_reset_event( struct esync *esync );
 void esync_abandon_mutexes( struct thread *thread );
+
+struct esync *create_esync( struct object *root, const struct unicode_str *name,
+                            unsigned int attr, int initval, int max, enum esync_type type,
+                            const struct security_descriptor *sd );
diff --git a/server/fsync.h b/server/fsync.h
index d4bd889a7f8..47b422f5f9c 100644
--- a/server/fsync.h
+++ b/server/fsync.h
@@ -34,3 +34,7 @@ extern void fsync_set_event( struct fsync *fsync );
 extern void fsync_reset_event( struct fsync *fsync );
 extern void fsync_abandon_mutexes( struct thread *thread );
 extern void fsync_cleanup_process_shm_indices( process_id_t id );
+
+extern struct fsync *create_fsync( struct object *root, const struct unicode_str *name,
+    unsigned int attr, int low, int high, enum fsync_type type,
+    const struct security_descriptor *sd );
-- 
2.51.2

