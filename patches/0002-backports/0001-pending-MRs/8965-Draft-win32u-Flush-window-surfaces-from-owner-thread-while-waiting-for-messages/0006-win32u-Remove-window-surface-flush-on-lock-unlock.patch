From 867832b0d7ca14f3a45e7c3d9652e81865898f0f Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?R=C3=A9mi=20Bernon?= <rbernon@codeweavers.com>
Date: Fri, 12 Sep 2025 12:28:14 +0200
Subject: [PATCH] win32u: Remove window surface flush on lock / unlock.

---
 dlls/win32u/dibdrv/dc.c   | 16 ++--------------
 include/wine/gdi_driver.h |  1 -
 2 files changed, 2 insertions(+), 15 deletions(-)

diff --git a/dlls/win32u/dibdrv/dc.c b/dlls/win32u/dibdrv/dc.c
index 8a72d9789ea..71599e48528 100644
--- a/dlls/win32u/dibdrv/dc.c
+++ b/dlls/win32u/dibdrv/dc.c
@@ -517,25 +517,13 @@ static inline struct windrv_physdev *get_windrv_physdev( PHYSDEV dev )
 static inline void lock_surface( struct windrv_physdev *dev )
 {
     struct window_surface *surface = dev->surface;
-
-    if (!dev->lock_count++)
-    {
-        window_surface_lock( surface );
-        if (IsRectEmpty( dev->dibdrv->bounds ) || !surface->draw_start_ticks)
-            surface->draw_start_ticks = NtGetTickCount();
-    }
+    if (!dev->lock_count++) window_surface_lock( surface );
 }
 
 static inline void unlock_surface( struct windrv_physdev *dev )
 {
     struct window_surface *surface = dev->surface;
-
-    if (!--dev->lock_count)
-    {
-        DWORD ticks = NtGetTickCount() - surface->draw_start_ticks;
-        window_surface_unlock( surface );
-        if (ticks > FLUSH_PERIOD) window_surface_flush( dev->surface );
-    }
+    if (!--dev->lock_count) window_surface_unlock( surface );
 }
 
 static inline void lock_surfaces( struct windrv_physdev *dst_dev, struct windrv_physdev *src_dev )
diff --git a/include/wine/gdi_driver.h b/include/wine/gdi_driver.h
index ef264cace97..432f00e8c62 100644
--- a/include/wine/gdi_driver.h
+++ b/include/wine/gdi_driver.h
@@ -303,7 +303,6 @@ struct window_surface
     pthread_mutex_t                    mutex;        /* mutex needed for any field below */
     RECT                               bounds;       /* dirty area rectangle */
     HRGN                               clip_region;  /* visible region of the surface, fully visible if 0 */
-    DWORD                              draw_start_ticks; /* start ticks of fresh draw */
     COLORREF                           color_key;    /* layered window surface color key, invalid if CLR_INVALID */
     UINT                               alpha_bits;   /* layered window global alpha bits, invalid if -1 */
     UINT                               alpha_mask;   /* layered window per-pixel alpha mask, invalid if 0 */
-- 
GitLab

