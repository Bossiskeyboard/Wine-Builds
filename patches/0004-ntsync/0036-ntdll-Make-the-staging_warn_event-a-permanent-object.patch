From ab515582c697ebaac466b51b1a457e35f8a18a21 Mon Sep 17 00:00:00 2001
From: William Horvath <william@horvath.blog>
Date: Wed, 2 Apr 2025 00:27:23 -0700
Subject: [PATCH 36/44] ntdll: Make the staging_warn_event a permanent object.

Avoids printing it repeatedly.
---
 dlls/ntdll/loader.c | 9 ++++-----
 1 file changed, 4 insertions(+), 5 deletions(-)

diff --git a/dlls/ntdll/loader.c b/dlls/ntdll/loader.c
index 117bb176173..30b23155645 100644
--- a/dlls/ntdll/loader.c
+++ b/dlls/ntdll/loader.c
@@ -4489,7 +4489,7 @@ void loader_init( CONTEXT *context, void **entry )
 {
     OBJECT_ATTRIBUTES staging_event_attr;
     UNICODE_STRING staging_event_string;
-    HANDLE staging_event;
+    HANDLE staging_event = 0;
     static int attach_done;
     NTSTATUS status;
     ULONG_PTR cookie, port = 0;
@@ -4591,17 +4591,16 @@ void loader_init( CONTEXT *context, void **entry )
          * add a comment here to try to prevent that. */
     }
     RtlInitUnicodeString( &staging_event_string, L"\\__wine_staging_warn_event" );
-    InitializeObjectAttributes( &staging_event_attr, &staging_event_string, OBJ_OPENIF, NULL, NULL );
+    InitializeObjectAttributes( &staging_event_attr, &staging_event_string, OBJ_OPENIF | OBJ_PERMANENT, NULL, NULL );
     if (NtCreateEvent( &staging_event, EVENT_ALL_ACCESS, &staging_event_attr, NotificationEvent, FALSE ) == STATUS_SUCCESS)
     {
         FIXME_(winediag)("wine-staging %s is a testing version containing experimental patches.\n", wine_get_version());
         FIXME_(winediag)("Please mention your exact version when filing bug reports on winehq.org.\n");
     }
     else
-    {
         WARN_(winediag)("wine-staging %s is a testing version containing experimental patches.\n", wine_get_version());
-        NtClose( staging_event );
-    }
+
+    NtClose( staging_event );
 
     NtCurrentTeb()->FlsSlots = fls_alloc_data();
 
-- 
2.51.2

